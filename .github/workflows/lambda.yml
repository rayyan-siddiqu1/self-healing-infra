name: Lambda CI/CD

on:
  push:
    branches:
      - master
      - main
    paths:
      - 'lambda/**'
      - '.github/workflows/lambda.yml'
  pull_request:
    branches:
      - master
      - main
    paths:
      - 'lambda/**'
      - '.github/workflows/lambda.yml'

env:
  PYTHON_VERSION: '3.11'
  AWS_REGION: 'us-east-1'

jobs:
  test:
    name: Test Lambda Functions
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Cache pip packages
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('lambda/**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pytest pytest-cov pytest-mock boto3 moto

          # Install function-specific dependencies
          for func in lambda/functions/*/requirements.txt; do
            if [ -f "$func" ] && [ -s "$func" ]; then
              echo "Installing dependencies from $func"
              pip install -r "$func"
            fi
          done

      - name: Lint with flake8
        run: |
          pip install flake8
          # Stop the build if there are Python syntax errors or undefined names
          flake8 lambda/ --count --select=E9,F63,F7,F82 --show-source --statistics
          # Exit-zero treats all errors as warnings
          flake8 lambda/ --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics

      - name: Run unit tests
        run: |
          if [ -d "lambda/tests" ]; then
            pytest lambda/tests/ -v --cov=lambda/functions --cov-report=xml --cov-report=term
          else
            echo "No tests directory found, skipping tests"
          fi

      - name: Upload coverage reports
        if: always()
        uses: codecov/codecov-action@v4
        with:
          file: ./coverage.xml
          flags: lambda
          name: lambda-coverage
          fail_ci_if_error: false

  build:
    name: Build Lambda Packages
    runs-on: ubuntu-latest
    needs: test
    strategy:
      matrix:
        function:
          - trigger_remediation
          - notify

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Build Lambda package
        run: |
          cd lambda/functions/${{ matrix.function }}

          # Create package directory
          mkdir -p package

          # Install dependencies if requirements.txt exists and is not empty
          if [ -f requirements.txt ] && [ -s requirements.txt ]; then
            pip install -r requirements.txt -t package/
          fi

          # Copy function code
          cp main.py package/

          # Create zip file
          cd package
          zip -r ../function.zip .
          cd ..

          # Verify zip file
          ls -lh function.zip
          unzip -l function.zip

      - name: Upload Lambda artifact
        uses: actions/upload-artifact@v4
        with:
          name: lambda-${{ matrix.function }}
          path: lambda/functions/${{ matrix.function }}/function.zip
          retention-days: 30

  deploy:
    name: Deploy Lambda Functions
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/master' || github.ref == 'refs/heads/main'
    strategy:
      matrix:
        function:
          - trigger_remediation
          - notify
        environment:
          - prod

    permissions:
      contents: read
      id-token: write

    environment:
      name: ${{ matrix.environment }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Download Lambda artifact
        uses: actions/download-artifact@v4
        with:
          name: lambda-${{ matrix.function }}
          path: ./lambda-package

      - name: Deploy to AWS Lambda
        run: |
          FUNCTION_NAME="self-healing-infra-${{ matrix.environment }}-${{ matrix.function }}"

          # Check if function exists
          if aws lambda get-function --function-name "$FUNCTION_NAME" 2>/dev/null; then
            echo "Updating existing Lambda function: $FUNCTION_NAME"
            aws lambda update-function-code \
              --function-name "$FUNCTION_NAME" \
              --zip-file fileb://lambda-package/function.zip

            # Wait for update to complete
            aws lambda wait function-updated --function-name "$FUNCTION_NAME"

            echo "Lambda function updated successfully"
          else
            echo "Lambda function $FUNCTION_NAME not found. Please deploy via Terraform first."
            exit 1
          fi

      - name: Publish new version
        id: publish
        run: |
          FUNCTION_NAME="self-healing-infra-${{ matrix.environment }}-${{ matrix.function }}"
          VERSION=$(aws lambda publish-version \
            --function-name "$FUNCTION_NAME" \
            --description "Deployed from GitHub Actions - Commit: ${{ github.sha }}" \
            --query 'Version' \
            --output text)
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Published version: $VERSION"

      - name: Update alias to new version
        run: |
          FUNCTION_NAME="self-healing-infra-${{ matrix.environment }}-${{ matrix.function }}"
          VERSION="${{ steps.publish.outputs.version }}"

          # Check if alias exists, create or update
          if aws lambda get-alias --function-name "$FUNCTION_NAME" --name live 2>/dev/null; then
            aws lambda update-alias \
              --function-name "$FUNCTION_NAME" \
              --name live \
              --function-version "$VERSION"
            echo "Updated 'live' alias to version $VERSION"
          else
            aws lambda create-alias \
              --function-name "$FUNCTION_NAME" \
              --name live \
              --function-version "$VERSION"
            echo "Created 'live' alias pointing to version $VERSION"
          fi

      - name: Run smoke tests
        run: |
          FUNCTION_NAME="self-healing-infra-${{ matrix.environment }}-${{ matrix.function }}"

          echo "Running smoke test for $FUNCTION_NAME"

          # Create test event based on function type
          if [ "${{ matrix.function }}" = "trigger_remediation" ]; then
            TEST_EVENT='{"Records":[{"EventSource":"aws:sns","Sns":{"Message":"{\"AlarmName\":\"test-alarm\",\"NewStateValue\":\"OK\"}"}}]}'
          else
            TEST_EVENT='{"message":"CI/CD smoke test","severity":"info"}'
          fi

          # Invoke function (async)
          aws lambda invoke \
            --function-name "$FUNCTION_NAME" \
            --invocation-type RequestResponse \
            --payload "$TEST_EVENT" \
            response.json

          # Check response
          cat response.json

          # Verify no errors
          if grep -q "errorMessage" response.json; then
            echo "Smoke test failed!"
            exit 1
          fi

          echo "Smoke test passed!"

  security-scan:
    name: Security Scan (Bandit)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install Bandit
        run: pip install bandit[toml]

      - name: Run Bandit security scan
        run: |
          bandit -r lambda/ -f json -o bandit-report.json || true
          bandit -r lambda/ -f screen

      - name: Upload Bandit report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: bandit-security-report
          path: bandit-report.json
          retention-days: 30
