name: Ansible CI/CD

on:
  push:
    branches:
      - master
      - main
    paths:
      - 'ansible/**'
      - '.github/workflows/ansible.yml'
  pull_request:
    branches:
      - master
      - main
    paths:
      - 'ansible/**'
      - '.github/workflows/ansible.yml'

jobs:
  lint:
    name: Ansible Lint
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Ansible and ansible-lint
        run: |
          python -m pip install --upgrade pip
          pip install ansible ansible-lint yamllint

      - name: Run yamllint
        run: |
          yamllint -c .yamllint ansible/ || true
        continue-on-error: true

      - name: Create yamllint config if not exists
        run: |
          if [ ! -f .yamllint ]; then
            cat > .yamllint << 'EOF'
          ---
          extends: default
          rules:
            line-length:
              max: 200
              level: warning
            indentation:
              spaces: 2
              indent-sequences: consistent
            comments:
              min-spaces-from-content: 1
            comments-indentation: disable
            truthy:
              allowed-values: ['true', 'false', 'yes', 'no']
          EOF
          fi

      - name: Run ansible-lint
        run: |
          cd ansible
          ansible-lint playbooks/*.yml || true
        continue-on-error: true

      - name: Syntax check playbooks
        run: |
          cd ansible
          for playbook in playbooks/*.yml; do
            echo "Checking syntax for $playbook"
            ansible-playbook --syntax-check "$playbook" \
              -i inventories/prod/aws_ec2.yml || true
          done

  validate:
    name: Validate Ansible Configuration
    runs-on: ubuntu-latest
    needs: lint

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Ansible
        run: |
          python -m pip install --upgrade pip
          pip install ansible boto3 botocore

      - name: Check playbook structure
        run: |
          cd ansible

          echo "Checking playbooks directory..."
          ls -la playbooks/

          echo "Checking roles directory..."
          if [ -d "roles" ]; then
            ls -la roles/
          fi

          echo "Checking inventories..."
          ls -la inventories/

      - name: Validate inventory files
        run: |
          cd ansible
          for inv in inventories/*/; do
            echo "Validating inventory: $inv"
            if [ -f "${inv}aws_ec2.yml" ]; then
              echo "AWS EC2 dynamic inventory found"
              cat "${inv}aws_ec2.yml"
            fi
          done

      - name: List all tasks
        run: |
          cd ansible
          echo "Available playbooks:"
          for playbook in playbooks/*.yml; do
            echo "  - $playbook"
            ansible-playbook "$playbook" --list-tasks \
              -i inventories/prod/aws_ec2.yml || true
          done

  security-scan:
    name: Security Scan (ansible-lint security)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install ansible-lint
        run: |
          pip install ansible-lint

      - name: Run security-focused ansible-lint
        run: |
          cd ansible
          # Run with profile that focuses on security issues
          ansible-lint --profile production playbooks/ || true
        continue-on-error: true

  test-dry-run:
    name: Test Playbooks (Dry Run)
    runs-on: ubuntu-latest
    needs: [lint, validate]
    if: github.event_name == 'pull_request'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Ansible and dependencies
        run: |
          python -m pip install --upgrade pip
          pip install ansible boto3 botocore

      - name: Configure AWS Credentials (for inventory)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1
        if: false  # Disabled by default - enable if you want to test against real inventory

      - name: Dry run playbooks
        run: |
          cd ansible
          echo "Running dry-run check for all playbooks..."

          # Create dummy inventory for dry-run
          cat > /tmp/test_inventory.ini << 'EOF'
          [web_servers]
          test-host-01 ansible_host=localhost ansible_connection=local

          [all:vars]
          ansible_python_interpreter=/usr/bin/python3
          EOF

          for playbook in playbooks/*.yml; do
            echo "Dry-run check for $playbook"
            ansible-playbook "$playbook" \
              -i /tmp/test_inventory.ini \
              --check \
              --diff || true
          done
        continue-on-error: true

  molecule-test:
    name: Molecule Tests
    runs-on: ubuntu-latest
    if: false  # Enable when molecule tests are added

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install molecule molecule-plugins[docker] ansible-lint

      - name: Run Molecule tests
        run: |
          cd ansible
          molecule test
